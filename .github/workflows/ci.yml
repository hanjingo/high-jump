name: CI/CD Pipeline

on:
  push:
    branches: [ master, main, dev, v1.x, cicd-test ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master, main ]

env:
  BUILD_TYPE: Release
  VCPKG_VERSION: '2024.01.12'

jobs:
  # ================================ Code Quality Checks ================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install code quality tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck clang-format clang-tidy
        pip install cpplint

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --std=c++17 --suppress=missingIncludeSystem \
          --error-exitcode=1 --xml libcpp/ 2> cppcheck-result.xml || true
        
    - name: Run clang-format check
      run: |
        find libcpp test -name "*.cpp" -o -name "*.hpp" | \
        xargs clang-format --dry-run --Werror

    - name: Run cpplint
      run: |
        find libcpp test -name "*.cpp" -o -name "*.hpp" | \
        xargs cpplint --filter=-legal/copyright,-build/include_subdir

    - name: Upload code quality reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-reports
        path: |
          cppcheck-result.xml
        retention-days: 30