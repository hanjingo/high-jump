name: CI/CD Pipeline

on:
  push:
    branches: [ master, main, dev, v1.x, cicd-test ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master, main ]

env:
  BUILD_TYPE: Release
  VCPKG_VERSION: '2024.01.12'

jobs:
  # ================================ Code Quality Checks ================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install code quality tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck clang-format-15 clang-tidy
        pip install cpplint

    - name: Check .clang-format existence
        run: |
          if [ ! -f .clang-format ]; then
            echo "::error file=.clang-format::Missing .clang-format configuration"
            exit 1
          fi

    - name: Run format validation
        run: |
          find src/ include/ -type f \( -name "*.cpp" -o -name "*.hpp" -o -name "*.c" -o -name "*.h" \) \
            | xargs clang-format --style=file --dry-run --Werror